---
title: "XMLib学习笔记"
date: 2021-09-22T11:19:31+08:00
draft: false
isCJKLanguage: true
---

## XMLib介绍

XMLib是一个动作游戏编辑器

- 逐帧动作编辑
- 逻辑与表现分离
- 动作逻辑实现简单
- 可用于帧同步
- 支持2D与3D

> 💡 Github地址：[https://github.com/PxGame/XMLib.AM](https://github.com/PxGame/XMLib.AM)



## 类图（Mermaid）

```mermaid
classDiagram
classa --> classB
```



## 执行顺序

- `GameManager`
  - `Awake()`：加载技能编辑器的配置文件，初始化Input数据类
  - `Update()`“：
    - InputUpdate：读取输入
    - LogicUpdate：这个函数确保了一种帧数稳定的Update实现
      - 执行`ActionMachineController.LogicUpdate`
      - ClearInputData：清空输入
- `ActionMachineController`
  - 挂载在一个Player的GameObject上作为
  - 指定配置文件
  - 引用animator、rigidBody、model、rotateSpeed等基础信息
  - 引用一个`IActionMachine`（实际上只有一个`ActionMachine`实现了这个接口）
  - `Start()`：
    - 初始化`(IActionMachine) actionMachine`
    - 根据`actionMachine`初始化播放的动画
    - 初始化其他数据
  - `Update()`：
    - `UpdateAnimation()`：根据一个timer与逻辑帧同步播放动画的实现
    - `UpdateRotation()`：根据旋转的速度来顺滑的播放模型的旋转
  - `LogicUpdate()`：
    - 逻辑Update，供`GameManager`统一调用
    - `actionMachine.LogicUpdate()`
    - `UpdateLogicAnimation()`：根据逻辑帧中写入的`eventTypes`来更新动画的播放时间（再在Update中更新动画的播放），与动画的切换融合
    - `CheckGround()`

- `ActionMachine`

  - 这个类本质时一个FSM，只是这个FSM的切换驱动都是基于数据的，保存在了config里，

    > 一个config 有多个 state，state之间的切换有配置的条件跳转的，有最后一帧回到默认状态的等等

  - 根据宏定义using到不同的`Single`数据类型和数学库

  - 初始化了很多的数据，包括顿帧信息、MachineConfig、StateConfig等





### 动画是如何播放的

在`ActionMachineController` --> `Update()` --> `UpdateAnimation()` --> `Animator.Update()`

这里主动的去调用`Animator.Update()`，并且同时把`Animator`这个组件置为Disable（其实可以用Animancer代替，感觉更好？）

### 如何保证动画的播放与逻辑表现一致

在主动调用`Animator.Update()`的时候有一个条件限制：

- 动画的播放也分为逻辑与表现，都在`ActionMachineController`类中
- 每个逻辑帧都增加`animatorTimer`，含义为动画的逻辑timer
- 播放动画的脚本只在`animatorTimer`有值的时候才会执行`Animator.Update()`

### 顿帧是如何实现的

> 💡 关于为什么会有GlobalActions不受顿帧影响，原作者表示，受伤和AI不应当受顿帧影响
